# TGç‡ŸéŠ·è»Ÿä»¶é›²ç«¯åŒæ­¥æ–¹æ¡ˆ

## ğŸŒ æ–¹æ¡ˆå°æ¯”

### æ–¹æ¡ˆAï¼šAPIåŒæ­¥æ¨¡å¼ï¼ˆæ¨è–¦ï¼‰
```
å®¢æˆ¶ç«¯è»Ÿä»¶ â†APIè«‹æ±‚â†’ é›²ç«¯æœå‹™å™¨ â†â†’ æ•¸æ“šåº«
     â†‘                    â†“
     â””â”€â”€â”€â”€â”€â”€ TGæ©Ÿå™¨äºº â”€â”€â”€â”€â”˜
```

**å„ªé»ï¼š**
- âœ… å®‰å…¨æ€§é«˜ï¼ˆå®¢æˆ¶ç«¯ä¸ç›´æ¥è¨ªå•æ•¸æ“šåº«ï¼‰
- âœ… å¯ä»¥æ·»åŠ æ¥­å‹™é‚è¼¯å’Œé©—è­‰
- âœ… æ”¯æŒç‰ˆæœ¬æ§åˆ¶å’Œå…¼å®¹æ€§ç®¡ç†
- âœ… ä¾¿æ–¼æ·»åŠ æ–°åŠŸèƒ½

**å¯¦ç¾æ–¹å¼ï¼š**
1. éƒ¨ç½²ä¸€å€‹FastAPI/Flaskæœå‹™å™¨
2. æä¾›æ¿€æ´»ç¢¼é©—è­‰API
3. å®¢æˆ¶ç«¯é€šéHTTPSè«‹æ±‚é©—è­‰

---

### æ–¹æ¡ˆBï¼šé›²æ•¸æ“šåº«ç›´é€£
```
å®¢æˆ¶ç«¯è»Ÿä»¶ â†â†’ é›²æ•¸æ“šåº« â†â†’ TGæ©Ÿå™¨äºº
```

**å„ªé»ï¼š**
- âœ… å¯¦ç¾ç°¡å–®ï¼Œæ”¹å‹•æœ€å°
- âœ… å¯¦æ™‚æ€§å¥½

**ç¼ºé»ï¼š**
- âŒ éœ€è¦åœ¨å®¢æˆ¶ç«¯ä¿å­˜æ•¸æ“šåº«æ†‘è­‰
- âŒ å®‰å…¨æ€§è¼ƒä½

---

### æ–¹æ¡ˆCï¼šå¯¦æ™‚åŒæ­¥æœå‹™
```
å®¢æˆ¶ç«¯ â†WebSocketâ†’ åŒæ­¥æœå‹™å™¨ â†â†’ æ•¸æ“šåº«
```

**å„ªé»ï¼š**
- âœ… å¯¦æ™‚æ¨é€æ›´æ–°
- âœ… é›™å‘åŒæ­¥

**é©ç”¨å ´æ™¯ï¼š**
- éœ€è¦å¯¦æ™‚ç›£æ§çš„å ´æ™¯
- å¤šè¨­å‚™åŒæ­¥

---

## ğŸš€ æ¨è–¦å¯¦ç¾ï¼šAPIåŒæ­¥æ–¹æ¡ˆ

### 1. æœå‹™ç«¯APIï¼ˆdeploy_api.pyï¼‰
```python
from fastapi import FastAPI, HTTPException
from pydantic import BaseModel
import json
import os
from datetime import datetime

app = FastAPI()

class ActivationRequest(BaseModel):
    activation_code: str
    device_id: str

class ActivationResponse(BaseModel):
    valid: bool
    message: str
    plan_type: str = None
    days: int = None
    expires_at: str = None

@app.post("/api/verify_activation", response_model=ActivationResponse)
async def verify_activation(request: ActivationRequest):
    """é©—è­‰æ¿€æ´»ç¢¼"""
    try:
        # è®€å–æ•¸æ“šåº«
        with open('bot_database.json', 'r') as f:
            db = json.load(f)
        
        code = request.activation_code.upper()
        
        # æª¢æŸ¥æ¿€æ´»ç¢¼æ˜¯å¦å­˜åœ¨
        if code not in db.get('activation_codes', {}):
            return ActivationResponse(
                valid=False,
                message="æ¿€æ´»ç¢¼ä¸å­˜åœ¨"
            )
        
        code_data = db['activation_codes'][code]
        
        # æª¢æŸ¥æ˜¯å¦å·²ä½¿ç”¨
        if code_data.get('used', False):
            return ActivationResponse(
                valid=False,
                message=f"æ¿€æ´»ç¢¼å·²æ–¼ {code_data.get('used_at', 'æœªçŸ¥æ™‚é–“')} ä½¿ç”¨é"
            )
        
        # æª¢æŸ¥æ˜¯å¦éæœŸ
        expires_at = code_data.get('expires_at')
        if expires_at:
            expire_time = datetime.fromisoformat(expires_at)
            if datetime.now() > expire_time:
                return ActivationResponse(
                    valid=False,
                    message="æ¿€æ´»ç¢¼å·²éæœŸ"
                )
        
        # æ¨™è¨˜ç‚ºå·²ä½¿ç”¨
        code_data['used'] = True
        code_data['used_at'] = datetime.now().isoformat()
        code_data['used_by_device'] = request.device_id
        
        # ä¿å­˜æ•¸æ“šåº«
        with open('bot_database.json', 'w') as f:
            json.dump(db, f, indent=2)
        
        return ActivationResponse(
            valid=True,
            message="æ¿€æ´»æˆåŠŸ",
            plan_type=code_data.get('plan_type'),
            days=code_data.get('days'),
            expires_at=expires_at
        )
        
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))

@app.get("/api/check_activation/{device_id}")
async def check_activation(device_id: str):
    """æª¢æŸ¥è¨­å‚™æ¿€æ´»ç‹€æ…‹"""
    try:
        with open('bot_database.json', 'r') as f:
            db = json.load(f)
        
        # æŸ¥æ‰¾è©²è¨­å‚™ä½¿ç”¨çš„æ¿€æ´»ç¢¼
        for code, data in db.get('activation_codes', {}).items():
            if data.get('used_by_device') == device_id:
                expires_at = data.get('expires_at')
                if expires_at:
                    expire_time = datetime.fromisoformat(expires_at)
                    if datetime.now() < expire_time:
                        remaining_days = (expire_time - datetime.now()).days + 1
                        return {
                            "activated": True,
                            "plan_type": data.get('plan_type'),
                            "remaining_days": remaining_days
                        }
        
        return {"activated": False}
        
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))
```

### 2. å®¢æˆ¶ç«¯ä¿®æ”¹ï¼ˆcloud_connector.pyï¼‰
```python
import requests
from typing import Dict, Optional
import json

class CloudActivationConnector:
    """é›²ç«¯æ¿€æ´»é€£æ¥å™¨"""
    
    def __init__(self, api_url: str = "https://your-api.com"):
        self.api_url = api_url
        self.device_id = self._get_device_id()
        
    def verify_activation(self, activation_code: str) -> tuple[bool, str]:
        """é©—è­‰æ¿€æ´»ç¢¼"""
        try:
            response = requests.post(
                f"{self.api_url}/api/verify_activation",
                json={
                    "activation_code": activation_code,
                    "device_id": self.device_id
                },
                timeout=10
            )
            
            if response.status_code == 200:
                data = response.json()
                if data['valid']:
                    # ä¿å­˜æœ¬åœ°æ¿€æ´»ä¿¡æ¯
                    self._save_local_activation(activation_code, data)
                    return True, data['message']
                else:
                    return False, data['message']
            else:
                return False, f"æœå‹™å™¨éŒ¯èª¤: {response.status_code}"
                
        except requests.RequestException as e:
            # ç¶²çµ¡éŒ¯èª¤æ™‚ï¼Œå˜—è©¦ä½¿ç”¨æœ¬åœ°ç·©å­˜
            return self._verify_offline(activation_code)
    
    def check_activation_status(self) -> Dict:
        """æª¢æŸ¥æ¿€æ´»ç‹€æ…‹"""
        try:
            response = requests.get(
                f"{self.api_url}/api/check_activation/{self.device_id}",
                timeout=5
            )
            
            if response.status_code == 200:
                return response.json()
            else:
                # ä½¿ç”¨æœ¬åœ°ç·©å­˜
                return self._check_local_status()
                
        except requests.RequestException:
            return self._check_local_status()
    
    def _save_local_activation(self, code: str, data: Dict):
        """ä¿å­˜æœ¬åœ°æ¿€æ´»ç·©å­˜ï¼ˆé›¢ç·šä½¿ç”¨ï¼‰"""
        cache_data = {
            "activation_code": code,
            "plan_type": data.get('plan_type'),
            "days": data.get('days'),
            "expires_at": data.get('expires_at'),
            "device_id": self.device_id,
            "activated_at": datetime.now().isoformat()
        }
        
        with open('activation_cache.json', 'w') as f:
            json.dump(cache_data, f)
    
    def _verify_offline(self, activation_code: str) -> tuple[bool, str]:
        """é›¢ç·šé©—è­‰ï¼ˆä½¿ç”¨æœ¬åœ°ç·©å­˜ï¼‰"""
        try:
            with open('activation_cache.json', 'r') as f:
                cache = json.load(f)
            
            if cache.get('activation_code') == activation_code:
                expires_at = datetime.fromisoformat(cache['expires_at'])
                if datetime.now() < expires_at:
                    return True, "é›¢ç·šé©—è­‰æˆåŠŸ"
                else:
                    return False, "æ¿€æ´»å·²éæœŸ"
            else:
                return False, "é›¢ç·šæ¨¡å¼ä¸‹ç„¡æ³•é©—è­‰æ–°æ¿€æ´»ç¢¼"
                
        except FileNotFoundError:
            return False, "ç„¡æ³•é€£æ¥åˆ°æœå‹™å™¨ï¼Œè«‹æª¢æŸ¥ç¶²çµ¡"
```

### 3. éƒ¨ç½²æ­¥é©Ÿ

#### é¸é …1ï¼šä½¿ç”¨Railwayéƒ¨ç½²
```bash
# 1. å‰µå»ºrequirements.txt
fastapi==0.104.1
uvicorn==0.24.0
python-multipart==0.0.6

# 2. å‰µå»ºProcfile
web: uvicorn deploy_api:app --host 0.0.0.0 --port $PORT

# 3. éƒ¨ç½²åˆ°Railway
railway login
railway init
railway up
```

#### é¸é …2ï¼šä½¿ç”¨VPSéƒ¨ç½²
```bash
# 1. å®‰è£ä¾è³´
pip install fastapi uvicorn

# 2. ä½¿ç”¨PM2é‹è¡Œ
pm2 start "uvicorn deploy_api:app --host 0.0.0.0 --port 8000" --name tg-api

# 3. é…ç½®Nginxåå‘ä»£ç†
server {
    listen 443 ssl;
    server_name api.yourdomain.com;
    
    location / {
        proxy_pass http://localhost:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

### 4. å®¢æˆ¶ç«¯é›†æˆ
```python
# ä¿®æ”¹æ¸¬è©¦6_TGæ©Ÿå™¨äººç‰ˆ.pyä¸­çš„é©—è­‰é‚è¼¯
def verify_activation_code(self, code):
    """é©—è­‰æ¿€æ´»ç¢¼ï¼ˆæ”¯æŒé›²ç«¯åŒæ­¥ï¼‰"""
    # å„ªå…ˆä½¿ç”¨é›²ç«¯API
    cloud_connector = CloudActivationConnector(
        api_url="https://your-api.railway.app"  # æ›¿æ›ç‚ºå¯¦éš›APIåœ°å€
    )
    
    success, message = cloud_connector.verify_activation(code)
    
    if success:
        return True, message
    else:
        # å¦‚æœé›²ç«¯å¤±æ•—ï¼Œå˜—è©¦æœ¬åœ°é©—è­‰ï¼ˆå‘å¾Œå…¼å®¹ï¼‰
        return self.verify_local_activation(code)
```

## ğŸ”’ å®‰å…¨å»ºè­°

1. **APIå¯†é‘°èªè­‰**
   ```python
   API_KEY = "your-secret-api-key"
   
   @app.middleware("http")
   async def verify_api_key(request, call_next):
       if request.headers.get("X-API-Key") != API_KEY:
           return JSONResponse(status_code=401, content={"error": "Invalid API key"})
       return await call_next(request)
   ```

2. **é€Ÿç‡é™åˆ¶**
   ```python
   from slowapi import Limiter
   limiter = Limiter(key_func=lambda: request.client.host)
   
   @app.post("/api/verify_activation")
   @limiter.limit("10/minute")
   async def verify_activation(request: ActivationRequest):
       # ...
   ```

3. **æ•¸æ“šåŠ å¯†**
   - ä½¿ç”¨HTTPSå‚³è¼¸
   - æ•æ„Ÿæ•¸æ“šåŠ å¯†å­˜å„²
   - å®šæœŸæ›´æ›APIå¯†é‘°

## ğŸ“Š ç›£æ§å’Œæ—¥èªŒ

```python
import logging

# é…ç½®æ—¥èªŒ
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler('api.log'),
        logging.StreamHandler()
    ]
)

@app.post("/api/verify_activation")
async def verify_activation(request: ActivationRequest):
    logger.info(f"é©—è­‰è«‹æ±‚: {request.activation_code} from {request.device_id}")
    # ...
```

## ğŸš€ å¿«é€Ÿé–‹å§‹

1. **æœ¬åœ°æ¸¬è©¦**
   ```bash
   uvicorn deploy_api:app --reload
   ```

2. **å®¢æˆ¶ç«¯æ¸¬è©¦**
   ```python
   connector = CloudActivationConnector("http://localhost:8000")
   success, message = connector.verify_activation("TEST1234")
   print(f"çµæœ: {success}, æ¶ˆæ¯: {message}")
   ```

3. **éƒ¨ç½²ä¸Šç·š**
   - é¸æ“‡åˆé©çš„é›²æœå‹™å•†
   - é…ç½®åŸŸåå’ŒSSL
   - æ›´æ–°å®¢æˆ¶ç«¯APIåœ°å€

---

é€™æ¨£æ‚¨çš„è»Ÿä»¶å°±èƒ½å¯¦ç¾å®Œæ•´çš„é›²ç«¯åŒæ­¥äº†ï¼